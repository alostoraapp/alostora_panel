version: "3.9"

networks:
  default:
    name: web_net

services:
  nginx:
    # This correctly pulls the image built by the CI/CD
    image: ghcr.io/alostoraapp/alostora_panel:latest
    container_name: admin_panel
    restart: on-failure

    # No build context and no app volumes are needed here
    # which is correct for this approach.

    networks:
      - default

    labels:
      # Your Traefik labels
      - "traefik.enable=true"
      - "traefik.docker.network=web_net"
      - "traefik.http.routers.webapp.entrypoints=http"
      - "traefik.http.routers.webapp.rule=Host(`panel.alostora.org`)"
      - "traefik.http.routers.webapp.service=webapp-secure"
      - "traefik.http.routers.webapp.middlewares=https-redirect"
      - "traefik.http.routers.webapp-secure.entrypoints=https"
      - "traefik.http.routers.webapp-secure.rule=Host(`panel.alostora.org`)"
      - "traefik.http.routers.webapp-secure.tls=true"
      - "traefik.http.routers.webapp-secure.tls.options=default"
      - "traefik.http.routers.webapp-secure.tls.certresolver=mycert"
      - "traefik.http.routers.webapp-secure.service=webapp-secure"
      - "traefik.http.services.webapp-secure.loadbalancer.server.port=80"
      - "traefik.http.middlewares.redirect-to-non-www.redirectregex.permanent=true"

# This volume is still defined but not used by nginx
# This is fine as your script in production.yaml cleans it up
volumes:
  admin_panel: